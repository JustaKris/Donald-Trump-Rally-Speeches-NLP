name: Deploy to Render (App is too heavy for Render)

on:
  # push:
  #   branches: [ main, develop, feature/* ]
  # pull_request:
  #   branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      # To set these secrets:
      # 1. Create Docker Hub account at https://hub.docker.com
      # 2. Go to Account Settings > Security > New Access Token
      # 3. Add DOCKERHUB_USERNAME and DOCKERHUB_TOKEN to GitHub Secrets
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/nlp-text-analysis-api:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/nlp-text-analysis-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Test Docker image
      run: |
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nlp-text-analysis-api:latest
        docker run -d -p 8000:8000 --name test-container ${{ secrets.DOCKERHUB_USERNAME }}/nlp-text-analysis-api:latest
        
        echo "Waiting 60 seconds for container to start..."
        sleep 60
        
        if curl -f http://localhost:8000/health; then
          echo "âœ… Health check passed!"
        else
          echo "âŒ Health check failed!"
          docker logs test-container
          exit 1
        fi
        
        docker stop test-container
    
    - name: Trigger Render deployment
      run: |
        # Render will automatically pull the latest image from Docker Hub
        # if configured to use docker.io/${{ secrets.DOCKERHUB_USERNAME }}/nlp-text-analysis-api:latest
        echo "Image pushed to Docker Hub successfully"
        echo "Render will automatically detect and deploy the new image"
        echo "Monitor deployment at: https://dashboard.render.com"
    
    - name: Deployment summary
      if: success()
      run: |
        echo "## Render Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Docker image built and pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Container tested successfully" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ Render will auto-deploy from Docker Hub" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Image: \`${{ secrets.DOCKERHUB_USERNAME }}/nlp-text-analysis-api:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- SHA: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Monitor deployment at https://dashboard.render.com" >> $GITHUB_STEP_SUMMARY
        echo "2. Check service logs for any issues" >> $GITHUB_STEP_SUMMARY
        echo "3. Test the deployed API endpoints once live" >> $GITHUB_STEP_SUMMARY

